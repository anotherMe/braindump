# Tables and chains

As stated by his name, //iptables// is based on **tables**. 

There are four of them:

* **filter**
* **nat**
* **mangle**
* **raw**

Each table is subsequently divided in **chains**:

* **filter**
  - **INPUT** (for packets destined to local sockets)
  - **FORWARD** (for packets being routed through the box)
  - **OUTPUT** (for locally-generated packets)
* **nat**
  - **PREROUTING** (for altering packets as soon as they come in)
  - **OUTPUT** (for altering locally-generated packets before routing)
  - **POSTROUTING** (for altering packets as they are about to go out)
* **mangle**
  - **OUTPUT** (for altering locally-generated packets before routing)
  - **INPUT** (for packets coming into the box itself)
  - **FORWARD** (for altering packets being routed through the box)
  - **POSTROUTING** (for altering packets as they are about to go out)
* **raw**
  - **PREROUTING** (for packets arriving via any network interface)
  - **OUTPUT** (for packets generated by local processes)

## How the chain works

When the packet matches one of the rules, it executes the associated action and is not checked against the remaining rules in the chain.

## Listing rules

List all rules in the **filter** table (which is the default one):

  # iptables -L

List all rules in **nat** table:

  # iptables -t nat -L

List all rules in the selected chain (eg: INPUT ):

  # iptables -L INPUT

List all rules by specification (just like they were typed):

  # iptables -S

List rules by line number:

  # iptables -nL --line-numbers

NOTE the -n flag avoids often long reverse DNS lookups.

## Setting chain default behaviour

( TODO: list behaviours )

<code>
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
</code>

## Adding rules

By default, new rules are added at the bottom of the list. See below to see how //insert// a new rule.

### Allow Incoming SSH only from a specific network

  iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
  iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

### Block a Specific ip-address

  iptables -A INPUT -s "$BLOCK_THIS_IP" -j DROP

## Inserting rules

Line numbers are your friends. Then start listing the current rules line numbers (see above). Then you can issue the command:

  # iptables -I INPUT {line-number} -s 202.54.1.2 -j DROP

to insert new rule at given position.

## Moving rules up and down the chain

You can't move rules. You have to delete the rule and the recreate it at wanted position. See //Inserting rules// for instructions.

## Deleting rules

### Delete rules based on line number

List the rules with their corresponding line number (see above). Then, to actually delete a rule:

  # iptable -D INPUT {line-number} -t filter

Above example interacts with the default table, so the -t parameter is redundant but, to avoid errors, __always specify the target table__ using the -t parameter.

### Delete rules based on specification

Firstly, list existing rules by specification ( see above ). Suppose the rule to delete was:

  # -A INPUT -p udp --dport 123 -j DROP

The corresponding delete command would be:

  # iptables -D INPUT -p udp --dport 123 -j DROP

NOTE we replaced the **-A** with **-D**.


### Reference

  * [25 Most Frequently Used Linux IPTables Rules Examples](https://crm.vpscheap.net/knowledgebase.php?action=displayarticle&id=29)

  * [Digital Ocean - How IPTables works](https://www.digitalocean.com/community/tutorials/how-the-iptables-firewall-works)